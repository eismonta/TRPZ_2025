<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Graphic Editor (Final Fix)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #e9ecef; display: flex; gap: 20px; padding: 20px; height: 100vh; margin: 0; box-sizing: border-box; }
        
        .sidebar {
            width: 260px; background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 10px; flex-shrink: 0;
        }
        h3 { margin: 5px 0; font-size: 1.1em; color: #333; }
        hr { border: 0; border-top: 1px solid #ddd; width: 100%; margin: 10px 0; }
        button {
            padding: 12px; border: none; border-radius: 8px; background-color: #007bff; color: white;
            font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: left; position: relative;
        }
        button:hover { background-color: #0056b3; transform: translateY(-1px); }
        button.tool { background-color: #6c757d; text-align: center; }
        button.tool.active { background-color: #28a745; box-shadow: 0 0 8px rgba(40, 167, 69, 0.5); }
        button.warning { background-color: #ffc107; color: #333; }
        button.danger { background-color: #dc3545; }

        .workspace {
            flex: 1; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center; overflow: auto; position: relative;
            background-image: radial-gradient(#ddd 1px, transparent 1px); background-size: 20px 20px; padding: 20px;
        }

        #layer-stack { position: relative; line-height: 0; width: fit-content; display: none; max-width: 100%; }
        
        #bg-layer { display: block; max-width: 100%; height: auto; position: relative; z-index: 1; pointer-events: none; }
        #draw-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair; touch-action: none; }
        
        #status-msg { color: #dc3545; font-weight: bold; text-align: center; margin-top: 10px; min-height: 20px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>üìÇ –ü—Ä–æ–µ–∫—Ç</h3>
    <input type="file" id="fileInput" accept="image/*">
    <button onclick="upload()">üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
    <button class="warning" onclick="undoAction()">‚Ü© –°–∫–∞—Å—É–≤–∞—Ç–∏ (Memento)</button>
    <button class="danger" onclick="archive()">üîí –í –ê—Ä—Ö—ñ–≤ (State)</button>

    <hr>
    <h3>üñåÔ∏è –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h3>
    <div style="display: flex; gap: 5px;">
        <button class="tool active" style="flex:1" onclick="setTool('brush')" id="btn-brush">–ü–µ–Ω–∑–ª–∏–∫</button>
        <button class="tool" style="flex:1" onclick="setTool('eraser')" id="btn-eraser">–ì—É–º–∫–∞</button>
    </div>

    <hr>
    <h3>‚ú® –§—ñ–ª—å—Ç—Ä–∏ (Prototype)</h3>
    <small style="color:gray; font-size: 0.8em; margin-bottom: 5px; display:block;">–û–±—Ä–æ–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:</small>
    <button onclick="applyFilter('grayscale')">–ß–æ—Ä–Ω–æ-–±—ñ–ª–∏–π</button>
    <button onclick="applyFilter('invert')">–Ü–Ω–≤–µ—Ä—Å—ñ—è –∫–æ–ª—å–æ—Ä—ñ–≤</button>

    <div id="status-msg"></div>
</div>

<div class="workspace">
    <span id="placeholder" style="color: #888; font-size: 1.2em;">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...</span>
    <div id="layer-stack">
        <img id="bg-layer" alt="Background">
        <canvas id="draw-layer"></canvas>
    </div>
</div>

<script>
    const stack = document.getElementById('layer-stack');
    const bgImg = document.getElementById('bg-layer');
    const canvas = document.getElementById('draw-layer');
    const ctx = canvas.getContext('2d');
    const statusMsg = document.getElementById('status-msg');
    const placeholder = document.getElementById('placeholder');

    let currentTool = 'brush', isDrawing = false;

    canvas.addEventListener('mousedown', e => { isDrawing = true; draw(e); });
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); syncLayer(); });
    canvas.addEventListener('mouseout', () => { isDrawing = false; ctx.beginPath(); });

    function draw(e) {
        if (!isDrawing) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left) * (canvas.width / rect.width);
        const y = (e.clientY - rect.top) * (canvas.height / rect.height);

        ctx.lineWidth = 10; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
        ctx.globalCompositeOperation = currentTool === 'brush' ? 'source-over' : 'destination-out';
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
        
        ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y);
    }

    function setTool(t) {
        currentTool = t;
        document.querySelectorAll('.tool').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + t).classList.add('active');
    }

    async function upload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!");
        
        const formData = new FormData();
        formData.append("file", file);
        statusMsg.innerText = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";

        try {
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            if(res.ok) {
                const data = await res.json();
                
                placeholder.style.display = 'none';
                stack.style.display = 'block';
                
                bgImg.src = "data:image/png;base64," + data.image;
                
                bgImg.onload = () => {
                    canvas.width = bgImg.naturalWidth;
                    canvas.height = bgImg.naturalHeight;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    bgImg.onload = null; 
                };
                statusMsg.innerText = "–ì–æ—Ç–æ–≤–æ";
            }
        } catch (e) { alert("–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"); }
    }

    async function syncLayer() {
        await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ image: canvas.toDataURL() })
        });
    }

    async function applyFilter(type) {
        statusMsg.innerText = "–û–±—Ä–æ–±–∫–∞...";
        await syncLayer(); 

        const res = await fetch(`/api/process/${type}`, { method: 'POST' });
        if (res.status === 403) {
            statusMsg.innerText = "üîí " + (await res.json()).error;
            return;
        }

        if(res.ok) {
            const data = await res.json();
            
            bgImg.src = "data:image/png;base64," + data.image;
            
            statusMsg.innerText = "–§—ñ–ª—å—Ç—Ä –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–æ";
        }
    }

    async function undoAction() {
        statusMsg.innerText = "–°–∫–∞—Å—É–≤–∞–Ω–Ω—è...";
        const res = await fetch('/api/undo', { method: 'POST' });
        if (res.ok) {
            const data = await res.json();
            bgImg.src = "data:image/png;base64," + data.image;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            statusMsg.innerText = "‚Ü© –î—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ";
        } else {
            statusMsg.innerText = "–ù–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏";
        }
    }
    
    async function archive() {
        if(!confirm("–ê—Ä—Ö—ñ–≤—É–≤–∞—Ç–∏?")) return;
        const res = await fetch('/api/archive', { method: 'POST' });
        statusMsg.innerText = "üîí " + await res.text();
        canvas.style.pointerEvents = 'none';
        document.body.style.opacity = "0.7";
    }
</script>

</body>
</html>