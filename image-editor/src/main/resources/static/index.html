<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Layered Image Editor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e9ecef;
            display: flex;
            gap: 20px;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            margin: 0;
        }

        /* –ü–ê–ù–ï–õ–¨ –Ü–ù–°–¢–†–£–ú–ï–ù–¢–Ü–í */
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: fit-content;
        }

        h3 { margin: 10px 0 5px 0; font-size: 1.1em; color: #333; }
        hr { border: 0; border-top: 1px solid #ddd; width: 100%; margin: 10px 0; }

        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: #007bff;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover { background-color: #0056b3; transform: translateY(-1px); }
        
        button.tool { background-color: #6c757d; }
        button.tool.active { background-color: #28a745; box-shadow: 0 0 8px rgba(40, 167, 69, 0.5); }
        
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #bd2130; }

        /* –†–û–ë–û–ß–ê –û–ë–õ–ê–°–¢–¨ (LAYERS) */
        .workspace {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
            position: relative;
            background-image: radial-gradient(#ddd 1px, transparent 1px);
            background-size: 20px 20px; /* –°—ñ—Ç–∫–∞ –¥–ª—è –ø—Ä–æ–∑–æ—Ä–æ—Å—Ç—ñ */
        }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –®–ê–†–Ü–í */
        #layer-stack {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            display: none; /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–æ –¥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        }

        /* –®–ê–† 0: –§–û–¢–û */
        #bg-layer {
            display: block;
            max-width: 100%;
            pointer-events: none; /* –©–æ–± –∫–ª—ñ–∫–∏ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ –∫—Ä—ñ–∑—å –∫–∞—Ä—Ç–∏–Ω–∫—É (—Ö–æ—á–∞ –≤–æ–Ω–∞ –∑–Ω–∏–∑—É) */
        }

        /* –®–ê–† 1: –ú–ê–õ–Æ–í–ê–ù–ù–Ø */
        #draw-layer {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
            /* –¶–µ–π —à–∞—Ä –ª–µ–∂–∏—Ç—å –∑–≤–µ—Ä—Ö—É */
        }

        #status-msg {
            color: #dc3545;
            font-weight: bold;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>üìÇ –ü—Ä–æ–µ–∫—Ç</h3>
        <input type="file" id="fileInput" accept="image/*">
        <button onclick="upload()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
        <button class="danger" onclick="archive()">üîí –í –ê—Ä—Ö—ñ–≤ (State)</button>

        <hr>
        <h3>üñåÔ∏è –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏</h3>
        <button class="tool active" onclick="setTool('brush')" id="btn-brush">–ü–µ–Ω–∑–ª–∏–∫</button>
        <button class="tool" onclick="setTool('eraser')" id="btn-eraser">–ì—É–º–∫–∞</button>

        <hr>
        <h3>‚ú® –§—ñ–ª—å—Ç—Ä–∏ (Prototype)</h3>
        <small style="color:gray; font-size: 0.8em; margin-bottom: 5px;">–î—ñ—é—Ç—å –Ω–∞ –Ω–∏–∂–Ω—ñ–π —à–∞—Ä</small>
        <button onclick="applyFilter('grayscale')">–ß–æ—Ä–Ω–æ-–±—ñ–ª–∏–π</button>
        <button onclick="applyFilter('invert')">–Ü–Ω–≤–µ—Ä—Å—ñ—è</button>

        <div id="status-msg"></div>
    </div>

    <div class="workspace">
        <span id="placeholder" style="color: #888;">–ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è...</span>
        
        <div id="layer-stack">
            <img id="bg-layer" alt="Background Layer">
            <canvas id="draw-layer"></canvas>
        </div>
    </div>

<script>
    const stack = document.getElementById('layer-stack');
    const bgImg = document.getElementById('bg-layer');
    const canvas = document.getElementById('draw-layer');
    const ctx = canvas.getContext('2d');
    const statusMsg = document.getElementById('status-msg');

    let currentTool = 'brush';
    let isDrawing = false;

    // --- –õ–û–ì–Ü–ö–ê –ú–ê–õ–Æ–í–ê–ù–ù–Ø (Frontend) ---
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', endDraw);
    canvas.addEventListener('mouseout', endDraw);

    function startDraw(e) {
        isDrawing = true;
        draw(e);
    }

    function draw(e) {
        if (!isDrawing) return;

        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        ctx.lineWidth = 10;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';

        if (currentTool === 'brush') {
            ctx.globalCompositeOperation = 'source-over';
            ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)'; // –ß–µ—Ä–≤–æ–Ω–∏–π –Ω–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π
        } else {
            // –ì–£–ú–ö–ê: –°—Ç–∏—Ä–∞—î –ø—ñ–∫—Å–µ–ª—ñ Canvas, —Ä–æ–±–ª—è—á–∏ –¥—ñ—Ä–∫—É –¥–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—ó –∑–Ω–∏–∑—É
            ctx.globalCompositeOperation = 'destination-out';
        }

        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
    }

    function endDraw() {
        if (!isDrawing) return;
        isDrawing = false;
        ctx.beginPath();
        syncLayer(); // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∑–º—ñ–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    }

    function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + tool).classList.add('active');
    }

    // --- –í–ó–ê–Ñ–ú–û–î–Ü–Ø –ó –°–ï–†–í–ï–†–û–ú ---

    async function upload() {
        const file = document.getElementById('fileInput').files[0];
        if (!file) return alert("–û–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª!");

        const formData = new FormData();
        formData.append("file", file);

        try {
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            
            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —Å—Ü–µ–Ω—É
            setupScene(data.image);
            statusMsg.innerText = "";
        } catch (e) {
            console.error(e);
            alert("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è");
        }
    }

    function setupScene(base64Image) {
        document.getElementById('placeholder').style.display = 'none';
        stack.style.display = 'block';

        // 1. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∫–∞—Ä—Ç–∏–Ω–∫—É –Ω–∞ –∑–∞–¥–Ω—ñ–π –ø–ª–∞–Ω (–®–∞—Ä 0)
        bgImg.src = "data:image/png;base64," + base64Image;

        // 2. –ö–æ–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è, –ø—ñ–¥–≥–∞–Ω—è—î–º–æ —Ä–æ–∑–º—ñ—Ä Canvas
        bgImg.onload = () => {
            canvas.width = bgImg.width;
            canvas.height = bgImg.height;
            // –û—á–∏—â–∞—î–º–æ canvas –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–∞–ª—é–Ω–∫–∞
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };
    }

    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ —à–∞—Ä –º–∞–ª—é–≤–∞–Ω–Ω—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    async function syncLayer() {
        const base64 = canvas.toDataURL("image/png");
        
        const res = await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ image: base64 })
        });

        if (res.status === 403) {
            statusMsg.innerText = "–ó–º—ñ–Ω–∏ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ (–ê—Ä—Ö—ñ–≤)";
            // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥—Ö–∏–ª–∏–≤, –º–æ–∂–Ω–∞ –æ—á–∏—Å—Ç–∏—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—ñ–π —à—Ç—Ä–∏—Ö (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        }
    }

    async function applyFilter(type) {
        // 1. –°–ø–æ—á–∞—Ç–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –º–∞–ª—é–Ω–æ–∫, —â–æ–± —Å–µ—Ä–≤–µ—Ä –º–∞–≤ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω
        await syncLayer();

        // 2. –ü—Ä–æ—Å–∏–º–æ —Å–µ—Ä–≤–µ—Ä –∑–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä
        const res = await fetch(`/api/process/${type}`, { method: 'POST' });
        
        if (res.status === 403) {
            statusMsg.innerText = "–ü—Ä–æ–µ–∫—Ç –≤ –∞—Ä—Ö—ñ–≤—ñ!";
            return;
        }

        const data = await res.json();
        
        // –í–ê–ñ–õ–ò–í–û: –°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î —Å–∫–ª–µ—î–Ω—É –∫–∞—Ä—Ç–∏–Ω–∫—É (Compositor.merge).
        // –ê–ª–µ –º–∏ —Ö–æ—á–µ–º–æ –∑–∞–ª–∏—à–∏—Ç–∏ –º–∞–ª—é–≤–∞–Ω–Ω—è –∂–∏–≤–∏–º –Ω–∞ canvas.
        // –¢–æ–º—É –º–∏ –æ–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ –∑–∞–¥–Ω—ñ–π —Ñ–æ–Ω, —è–∫—â–æ —Ñ—ñ–ª—å—Ç—Ä –º—ñ–Ω—è–≤ —Ç—ñ–ª—å–∫–∏ –π–æ–≥–æ.
        // (–î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏ –≤ —Ü—å–æ–º—É –ø—Ä–æ–µ–∫—Ç—ñ –º–∏ –ø—Ä–æ—Å—Ç–æ –æ–Ω–æ–≤–ª—é—î–º–æ —Ñ–æ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º).
        
        bgImg.src = "data:image/png;base64," + data.image;
        
        // –û—Å–∫—ñ–ª—å–∫–∏ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ Merged –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–§–æ–Ω + –ú–∞–ª—é–Ω–æ–∫),
        // –∞ —É –Ω–∞—Å –º–∞–ª—é–Ω–æ–∫ —â–µ —î –Ω–∞ Canvas, –≤—ñ–Ω –Ω–∞–∫–ª–∞–¥–µ—Ç—å—Å—è —Å–∞–º –Ω–∞ —Å–µ–±–µ —ñ —Å—Ç–∞–Ω–µ –∂–∏—Ä–Ω—ñ—à–∏–º.
        // –©–æ–± —Ü—å–æ–≥–æ —É–Ω–∏–∫–Ω—É—Ç–∏, –æ—á–∏—Å—Ç–∏–º–æ Canvas, –±–æ —Ç–µ–ø–µ—Ä –º–∞–ª—é–Ω–æ–∫ "–≤–ø—ñ–∫—Å—è" –≤ —Ñ–æ–Ω.
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function archive() {
        if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ? –¶–µ –∑–∞–±–ª–æ–∫—É—î —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.")) return;
        
        const res = await fetch('/api/archive', { method: 'POST' });
        const text = await res.text();
        
        statusMsg.innerText = text;
        
        // –í—ñ–∑—É–∞–ª—å–Ω–µ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è
        canvas.style.pointerEvents = 'none'; // –ó–∞–±–æ—Ä–æ–Ω—è—î –º–∞–ª—é–≤–∞—Ç–∏
        document.body.style.opacity = "0.8";
    }

</script>

</body>
</html>